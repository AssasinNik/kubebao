---
# SecretProviderClass for CSI driver
# This is used by pods to request secrets from OpenBao via CSI
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: kubebao-secrets
  namespace: default
spec:
  provider: kubebao
  parameters:
    # OpenBao role for authentication
    roleName: "my-app"
    
    # Objects to fetch from OpenBao
    objects: |
      - objectName: "db-password"
        secretPath: "secret/data/myapp/database"
        secretKey: "password"
      - objectName: "api-key"
        secretPath: "secret/data/myapp/api"
        secretKey: "key"
      - objectName: "config.json"
        secretPath: "secret/data/myapp/config"
        # No secretKey = entire secret as JSON
---
# SecretProviderClass with Kubernetes Secret sync
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: kubebao-secrets-sync
  namespace: default
spec:
  provider: kubebao
  parameters:
    roleName: "my-app"
    objects: |
      - objectName: "username"
        secretPath: "secret/data/myapp/database"
        secretKey: "username"
      - objectName: "password"
        secretPath: "secret/data/myapp/database"
        secretKey: "password"
  
  # Sync to Kubernetes Secret for env vars
  secretObjects:
    - secretName: db-credentials
      type: Opaque
      data:
        - objectName: username
          key: DB_USERNAME
        - objectName: password
          key: DB_PASSWORD
---
# Example Pod using SecretProviderClass
apiVersion: v1
kind: Pod
metadata:
  name: my-app
  namespace: default
spec:
  serviceAccountName: my-app
  containers:
    - name: app
      image: my-app:latest
      # Mount secrets as files
      volumeMounts:
        - name: secrets
          mountPath: "/mnt/secrets"
          readOnly: true
      # Use synced secret as env vars
      env:
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: DB_USERNAME
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: DB_PASSWORD
  volumes:
    - name: secrets
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: kubebao-secrets-sync
